<div class="dashboard-container">
  <aside class="sidebar">
    <img src="assets/images/profilpic.jpg" alt="Photo de profil" class="profile" />
    <h1 class="brand">Dashboard Transactionnel</h1>
    <p class="user-name">{{ nomEmploye }}</p>
    <p class="department">{{ department }}</p>

    <nav>
      <a class="nav-item" (click)="refreshData()">ğŸ”„ Actualiser</a>
      
      <a class="nav-item" 
         [class.active]="activeTab === 'transactions'"
         (click)="setActiveTab('transactions')">
        ğŸ“Š Transactions
      </a>
      
      <a class="nav-item" 
         [class.active]="activeTab === 'litiges-recus'"
         (click)="setActiveTab('litiges-recus')">
        ğŸš¨ Litiges ReÃ§us
        <span class="badge" *ngIf="litigesRecus.length > 0">
          {{ litigesRecus.length }}
        </span>
      </a>
      
      <a class="nav-item" 
         [class.active]="activeTab === 'litiges-emis'"
         (click)="setActiveTab('litiges-emis')">
        ğŸš© Litiges Ã‰mis
        <span class="badge" *ngIf="litigesAcquereur.length > 0">
          {{ litigesAcquereur.length }}
        </span>
      </a>
      
      <a class="nav-item" 
         [class.active]="activeTab === 'chargeback'"
         (click)="setActiveTab('chargeback')">
        ğŸ’³ Chargeback
        <span class="chargeback-badge" *ngIf="chargebacks && chargebacks.length > 0">
          {{ chargebacks.length }}
        </span>
      </a>
      
      <hr class="nav-separator">
      
      <a class="nav-item" (click)="toggleNotificationPanel()" [class.active]="showNotificationPanel">
        ğŸ”” Notifications 
        <span class="badge" *ngIf="unreadNotifications.length > 0">
          {{ unreadNotifications.length }}
        </span>
      </a>
      <a class="nav-item" href="#">ğŸ‘¤ Profil EmployÃ©</a>
      <a class="nav-item" (click)="showBusinessRulesInfo()">â„¹ï¸ RÃ¨gles MÃ©tier</a>
      <a class="nav-item" (click)="debugBanqueDeclarante()">ğŸ› Debug</a>
    </nav>
  </aside>

  <!-- PANNEAU DE NOTIFICATIONS -->
  <div class="notification-container">
    <div class="notification-icon" (click)="toggleNotificationPanel()">
      ğŸ”” 
      <span *ngIf="unreadNotifications.length > 0" class="notification-badge">
        +{{ unreadNotifications.length }}
      </span>
    </div>

    <div class="notification-panel" *ngIf="showNotificationPanel">
      <div class="notification-header">
        <h3>ğŸ”” Notifications</h3>
        <button class="close-btn" (click)="toggleNotificationPanel()">âœ•</button>
      </div>
      
      <div class="notification-content">
        <div *ngIf="unreadNotifications.length === 0" class="no-notifications">
          âœ… Aucune nouvelle notification
        </div>
        
        <div *ngFor="let notification of unreadNotifications" 
             class="notification-item" 
             (click)="goToTransaction(notification)">
          
          <div class="notification-icon-item">ğŸš©</div>
          <div class="notification-details">
            <div class="notification-title">
              Nouveau litige signalÃ©
            </div>
            <div class="notification-info">
              Transaction: {{ notification.transaction && notification.transaction.reference || 'N/A' }}
            </div>
            <div class="notification-meta">
              Montant: {{ notification.transaction && formatCurrency(notification.transaction.montant) || '0,00 MAD' }}
            </div>
            <div class="notification-date">
              {{ formatDate(notification.dateCreation) }}
            </div>
          </div>
          <div class="notification-arrow">â†’</div>
        </div>
      </div>
    </div>
  </div>

  <main class="content">
    <!-- HEADER -->
    <div class="header-section">
      <div class="header-content">
        <h2 class="welcome-text">ğŸ‘‹ Bienvenue, {{ nomEmploye }}</h2>
        <p class="institution-info">
          <strong>Institution :</strong> {{ institution }} | 
          <strong>DÃ©partement :</strong> {{ department }}
        </p>
        <div class="business-rules-info" *ngIf="totalTransactions !== totalSignalableTransactions">
          <small class="info-text">
            â„¹ï¸ Affichage conforme aux rÃ¨gles mÃ©tier bancaires : 
            {{ totalSignalableTransactions }} transactions signalables sur {{ totalTransactions }} totales
          </small>
        </div>
      </div>
      <img src="assets/images/logodms.jpg" alt="Logo" class="logo" />
    </div>

    <!-- STATS GRID -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“„</div>
        <div class="stat-content">
          <div class="stat-value">{{ totalSignalableTransactions }}</div>
          <div class="stat-label">Transactions Signalables</div>
          <div class="stat-sublabel">{{ totalTransactions }} au total</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-content">
          <div class="stat-value">{{ totalAmount }}</div>
          <div class="stat-label">Montant Total</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-content">
          <div class="stat-value">{{ averageAmount }}</div>
          <div class="stat-label">Montant Moyen</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸš©</div>
        <div class="stat-content">
          <div class="stat-value">{{ flaggedCount }}</div>
          <div class="stat-label">Transactions SignalÃ©es</div>
        </div>
      </div>
    </div>

    <!-- ========== ONGLET TRANSACTIONS ========== -->
    <div *ngIf="activeTab === 'transactions'">
      
      <!-- FILTRES + IMPORT -->
      <div class="actions">
        <input type="text" 
               [(ngModel)]="searchTerm" 
               (ngModelChange)="filterTransactions()" 
               placeholder="ğŸ” Rechercher par rÃ©fÃ©rence, type, montant..." />
        
        <select [(ngModel)]="statutFilter" (change)="filterTransactions()">
          <option value="">Tous les statuts</option>
          <option *ngFor="let s of uniqueStatuts" [value]="s">{{ s }}</option>
        </select>
        
        <select [(ngModel)]="typeFilter" (change)="filterTransactions()">
          <option value="">Tous les types</option>
          <option *ngFor="let t of uniqueTypes" [value]="t">{{ t }}</option>
        </select>
        
        <button (click)="exportToCSV()" class="btn-download">ğŸ“¥ TÃ©lÃ©charger CSV</button>
        <button (click)="clearFilters()" class="btn-clear">ğŸ—‘ï¸ Effacer filtres</button>

        <label class="btn-download">
          ğŸ“¤ Importer fichier CMI
          <input type="file" (change)="onFileSelected($event)" hidden accept=".csv" />
        </label>
        
        <span *ngIf="selectedFileName" class="selected-file">ğŸ“‚ {{ selectedFileName }}</span>
        <span *ngIf="isUploadingFile" class="uploading">â³ Upload en cours...</span>
      </div>

      <!-- LOADER TRANSACTIONS -->
      <div *ngIf="isLoadingTransactions" class="loader">
        <div class="spinner"></div>
        <p>Chargement des transactions...</p>
      </div>

      <!-- SECTION D'INFORMATION RÃˆGLES MÃ‰TIER -->
      <div class="business-rules-banner" *ngIf="!isLoadingTransactions && totalTransactions > totalSignalableTransactions">
        <div class="banner-content">
          <div class="banner-icon">ğŸ¦</div>
          <div class="banner-text">
            <strong>RÃ¨gles mÃ©tier bancaires appliquÃ©es</strong>
            <p>Seules les transactions oÃ¹ votre banque est Ã©mettrice ou acquÃ©reuse sont affichÃ©es.</p>
            <small>{{ totalTransactions - totalSignalableTransactions }} transactions d'autres banques masquÃ©es</small>
          </div>
          <button class="banner-btn" (click)="showBusinessRulesInfo()">
            â„¹ï¸ En savoir plus
          </button>
        </div>
      </div>

      <!-- TABLE TRANSACTIONS -->
      <div *ngIf="!isLoadingTransactions" class="table-container">
        <h3>ğŸ“Š Transactions Signalables ({{ filteredTransactions.length }})</h3>
        <table class="transactions">
          <thead>
            <tr>
              <th>RÃ©f</th>
              <th>Montant</th>
              <th>Date</th>
              <th>Type</th>
              <th>RÃ´le de votre banque</th>
              <th>Statut</th>
              <th>âš  Litige</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of paginatedTransactions" 
                [class]="getTransactionRowClass(t)">
              
              <td data-label="RÃ©f">
                <strong>{{ t.reference || 'N/A' }}</strong>
                <small *ngIf="t.satimData && t.satimData.strCode" class="satim-code">
                  SATIM: {{ t.satimData.strCode }}
                </small>
              </td>
              
              <td data-label="Montant">{{ formatCurrency(t.montant) }}</td>
              
              <td data-label="Date">{{ formatDate(t.dateTransaction) }}</td>
              
              <td data-label="Type">
                {{ t.type || 'N/A' }}
                <small *ngIf="t.satimData && t.satimData.strTermIden" class="terminal-info">
                  Terminal: {{ t.satimData.strTermIden }}
                </small>
              </td>

              <!-- RÃ´le de la banque -->
              <td data-label="RÃ´le">
                <div class="bank-role">
                  <span *ngIf="t.banqueEmettrice?.id === institutionId" class="role-badge issuer">
                    ğŸ§ Ã‰mettrice
                  </span>
                  <span *ngIf="t.banqueAcquereuse?.id === institutionId" class="role-badge acquirer">
                    ğŸª AcquÃ©reuse
                  </span>
                </div>
              </td>
              
              <td data-label="Statut">
                <span [class]="'status-' + (t.statut || '').toLowerCase().replace('_', '-')">
                  {{ t.statut || 'NORMALE' }}
                </span>
              </td>
              
              <td data-label="Litige">
                <div *ngIf="t.statut === 'AVEC_LITIGE'" class="litige-indicator">
                  <div class="litige-flag">ğŸš© Oui</div>
                  <div *ngIf="t.banqueDeclaranteNom" class="banque-declarante"
                       [class.our-bank]="t.banqueDeclaranteNom.includes('Notre banque')"
                       [class.external-bank]="!t.banqueDeclaranteNom.includes('Notre banque')">
                    <small>ğŸ¦ SignalÃ© par:</small>
                    <strong>{{ t.banqueDeclaranteNom }}</strong>
                  </div>
                </div>
                <span *ngIf="t.statut !== 'AVEC_LITIGE'" class="no-litige">âŒ Non</span>
              </td>
              
              <!-- ACTION AVEC BOUTON CHARGEBACK INTÃ‰GRÃ‰ -->
              <td data-label="Action">
                <div class="action-buttons-container">
                  
                  <!-- BOUTON SIGNALER -->
                  <button 
                    class="btn-flag" 
                    *ngIf="t.statut !== 'AVEC_LITIGE'" 
                    (click)="flagTransaction(t)"
                    [disabled]="clickedTransactions.has(getTransactionId(t))"
                    title="Signaler cette transaction selon les rÃ¨gles mÃ©tier bancaires">
                    <span *ngIf="!clickedTransactions.has(getTransactionId(t))">ğŸš© Signaler</span>
                    <span *ngIf="clickedTransactions.has(getTransactionId(t))">â³ En cours...</span>
                  </button>
                  
                  <!-- BOUTON CHARGEBACK -->
                  <button 
                    class="btn-chargeback" 
                    *ngIf="canInitiateChargeback(t)"
                    (click)="openChargebackModal(t)"
                    title="Initier un chargeback pour cette transaction (Banque Ã©mettrice uniquement)">
                    ğŸ’³ Chargeback
                  </button>
                  
                  <!-- MESSAGE INFORMATIF CHARGEBACK -->
                  <small class="chargeback-info" *ngIf="t.statut === 'AVEC_LITIGE' && !canInitiateChargeback(t)">
                    <span *ngIf="t.banqueEmettrice?.id !== institutionId" class="not-issuer">
                      â„¹ï¸ Chargeback disponible pour la banque Ã©mettrice uniquement
                    </span>
                    <span *ngIf="t.banqueEmettrice?.id === institutionId" class="chargeback-exists">
                      ğŸ’³ Chargeback dÃ©jÃ  initiÃ© ou en cours
                    </span>
                  </small>
                  
                  <!-- BOUTON DÃ‰TAILS -->
                  <button 
                    class="btn-details" 
                    (click)="openTransactionDetails(t)"
                    title="Voir les dÃ©tails complets de la transaction">
                    ğŸ‘ï¸ DÃ©tails
                  </button>
                  
                  <!-- STATUS DÃ‰JÃ€ SIGNALÃ‰ -->
                  <div *ngIf="t.statut === 'AVEC_LITIGE'" class="already-flagged">
                    <span class="flag-status">âœ… SignalÃ©</span>
                    
                    <!-- INDICATEUR CHARGEBACK ACTIF -->
                    <div class="chargeback-status" *ngIf="hasActiveChargeback(t)">
                      <span class="chargeback-active">ğŸ’³ Chargeback actif</span>
                      <small class="chargeback-phase">Phase: {{ getActiveChargebackPhase(t) }}</small>
                    </div>
                  </div>
                  
                </div>
              </td>
            </tr>
            
            <tr *ngIf="paginatedTransactions.length === 0" class="no-data">
              <td colspan="8">
                <div class="no-data-content">
                  <div class="no-data-icon">ğŸ“­</div>
                  <p><strong>Aucune transaction signalable trouvÃ©e.</strong></p>
                  <p *ngIf="searchTerm || statutFilter || typeFilter">
                    Essayez de modifier vos critÃ¨res de recherche.
                  </p>
                  <p *ngIf="!searchTerm && !statutFilter && !typeFilter">
                    Votre banque n'a aucune transaction oÃ¹ elle est Ã©mettrice ou acquÃ©reuse.
                  </p>
                  <button (click)="clearFilters()" class="btn-clear-inline">Effacer les filtres</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- PAGINATION -->
        <div class="pagination" *ngIf="totalPages > 1">
          <button (click)="goToPage(currentPage - 1)" 
                  [disabled]="!canGoToPrevious" 
                  class="pagination-btn">
            â€¹ PrÃ©cÃ©dent
          </button>
          
          <button *ngFor="let page of paginationArray" 
                  [class.active]="currentPage === page"
                  (click)="goToPage(page)"
                  class="pagination-btn">
            {{ page }}
          </button>
          
          <button (click)="goToPage(currentPage + 1)" 
                  [disabled]="!canGoToNext" 
                  class="pagination-btn">
            Suivant â€º
          </button>
        </div>

        <!-- INFO PAGINATION -->
        <div class="pagination-info" *ngIf="filteredTransactions.length > 0">
          Affichage de {{ (currentPage - 1) * itemsPerPage + 1 }} Ã  
          {{ getMaxDisplayed() }} 
          sur {{ filteredTransactions.length }} transactions signalables
        </div>
      </div>
    </div>
    <!-- ========== ONGLET LITIGES REÃ‡US ========== -->
    <div *ngIf="activeTab === 'litiges-recus'">
      
      <div *ngIf="isLoadingLitiges" class="loader">
        <div class="spinner"></div>
        <p>Chargement des litiges reÃ§us...</p>
      </div>

      <div *ngIf="!isLoadingLitiges" class="table-container">
        <h3>ğŸš¨ Litiges reÃ§us d'autres banques ({{ litigesRecus.length }})</h3>
        
        <div class="page-description">
          <div class="description-icon">ğŸš¨</div>
          <div class="description-text">
            <strong>Litiges reÃ§us</strong> - Litiges signalÃ©s par d'autres banques concernant vos transactions.
            <br>
            <small>Vous devez analyser et rÃ©pondre Ã  ces litiges selon les procÃ©dures bancaires.</small>
          </div>
        </div>
        
        <table class="transactions" *ngIf="litigesRecus.length > 0">
          <thead>
            <tr>
              <th>ID Litige</th>
              <th>Type de litige</th>
              <th>Banque DÃ©clarante</th>
              <th>Date crÃ©ation</th>
              <th>Description</th>
              <th>Statut</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let lr of litigesRecus" class="litige-recu-row external-litige">
              <td data-label="ID">
                <strong>#{{ lr.id }}</strong>
              </td>
              
              <td data-label="Type">
                <span class="litige-type">{{ lr.type || 'N/A' }}</span>
              </td>
              
              <td data-label="Banque DÃ©clarante">
                <div class="declaring-bank">
                  <strong>{{ lr.banqueDeclaranteNom || 'Banque inconnue' }}</strong>
                  <small *ngIf="lr.banqueDeclaranteNom && lr.banqueDeclaranteNom !== 'Banque inconnue'">
                    ğŸ¦ Institution externe
                  </small>
                </div>
              </td>
              
              <td data-label="Date">
                {{ formatDate(lr.dateCreation) }}
              </td>
              
              <td data-label="Description">
                <div class="description-cell">
                  {{ lr.description || 'Aucune description' }}
                </div>
              </td>
              
              <td data-label="Statut">
                <span [class]="'status-' + (lr.statut || '').toLowerCase()">
                  {{ lr.statut || 'NOUVEAU' }}
                </span>
              </td>
              
              <td data-label="Action">
                <div class="action-buttons-container">
                  <button class="btn-respond" title="RÃ©pondre au litige (ReprÃ©sentation)">
                    ğŸ’¬ Contester
                  </button>
                  <button 
                    class="btn-details" 
                    (click)="openLitigeDetails(lr.id)"
                    title="Voir tous les dÃ©tails du litige avec heure de crÃ©ation">
                    ğŸ‘ï¸ DÃ©tails
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="litigesRecus.length === 0" class="no-data-content">
          <div class="no-data-icon">âœ…</div>
          <p><strong>Aucun litige reÃ§u d'autres banques.</strong></p>
          <small>Excellente nouvelle ! Aucune autre banque n'a signalÃ© de problÃ¨me avec vos transactions.</small>
        </div>
      </div>
    </div>

    <!-- ========== ONGLET LITIGES Ã‰MIS ========== -->
    <div *ngIf="activeTab === 'litiges-emis'">
      
      <div *ngIf="isLoadingLitiges" class="loader">
        <div class="spinner"></div>
        <p>Chargement des litiges Ã©mis...</p>
      </div>

      <div *ngIf="!isLoadingLitiges" class="table-container">
        <h3>ğŸ“Œ Litiges signalÃ©s par notre banque ({{ litigesAcquereur.length }})</h3>
        
        <div class="page-description">
          <div class="description-icon">ğŸ“Œ</div>
          <div class="description-text">
            <strong>Litiges Ã©mis</strong> - Litiges que vous avez signalÃ©s concernant des transactions.
            <br>
            <small>Suivez l'Ã©tat de vos signalements et gÃ©rez les rÃ©ponses des autres banques.</small>
          </div>
        </div>
        
        <table class="transactions" *ngIf="litigesAcquereur.length > 0">
          <thead>
            <tr>
              <th>ID Litige</th>
              <th>RÃ©fÃ©rence Transaction</th>
              <th>Montant</th>
              <th>Date Transaction</th>
              <th>Type de litige</th>
              <th>Institution ConcernÃ©e</th>
              <th>Statut</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let l of litigesAcquereur" class="litige-row our-litige">
              <td data-label="ID Litige">
                <strong>#{{ l.id }}</strong>
              </td>
              
              <td data-label="RÃ©fÃ©rence">
                {{ l.transaction && l.transaction.reference || 'N/A' }}
              </td>
              
              <td data-label="Montant">
                {{ l.transaction && formatCurrency(l.transaction.montant) || '0,00 MAD' }}
              </td>
              
              <td data-label="Date">
                {{ l.transaction && formatDate(l.transaction.dateTransaction) || 'N/A' }}
              </td>
              
              <td data-label="Type">
                <span class="litige-type">{{ l.type || 'AUTRE' }}</span>
              </td>
              
              <td data-label="Institution ConcernÃ©e">
                <strong>{{ l.institutionDeclarantNom || 'Institution inconnue' }}</strong>
              </td>
              
              <td data-label="Statut">
                <span [class]="'status-' + (l.statut || '').toLowerCase()">
                  {{ l.statut || 'EN_COURS' }}
                </span>
              </td>
              
              <td data-label="Action">
                <div class="action-buttons-container">
                  <button class="btn-view" (click)="goToTransaction(l)" title="Voir la transaction associÃ©e">
                    ğŸ‘ï¸ Voir Transaction
                  </button>
                  <button 
                    class="btn-details" 
                    (click)="openLitigeDetails(l.id)"
                    title="Voir les dÃ©tails complets du litige">
                    ğŸ‘ï¸ DÃ©tails
                  </button>
                  <button class="btn-edit" title="Modifier le litige">
                    ğŸ“ Modifier
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        
        <div *ngIf="litigesAcquereur.length === 0" class="no-data-content">
          <div class="no-data-icon">ğŸ“­</div>
          <p><strong>Aucun litige signalÃ© par votre banque.</strong></p>
          <small>Les transactions que vous signalez apparaÃ®tront ici.</small>
        </div>
      </div>
    </div>
    <!-- ========== ONGLET CHARGEBACK ========== -->
    <div *ngIf="activeTab === 'chargeback'" class="chargeback-section">
      
      <!-- HEADER SECTION -->
      <div class="chargeback-header">
        <h3>ğŸ’³ Gestion des Chargebacks</h3>
        <div class="page-description">
          <div class="description-icon">ğŸ’³</div>
          <div class="description-text">
            <strong>Module Chargeback</strong> - GÃ©rez les demandes de chargeback selon les procÃ©dures bancaires.
            <br>
            <small>Initiez, suivez et gÃ©rez les chargebacks pour les transactions litigieuses oÃ¹ votre banque est Ã©mettrice.</small>
          </div>
        </div>
      </div>

      <!-- LOADER CHARGEBACKS -->
      <div *ngIf="isLoadingChargebacks" class="loader">
        <div class="spinner"></div>
        <p>Chargement des chargebacks...</p>
      </div>

      <!-- SECTION PRINCIPALE CHARGEBACKS -->
      <div *ngIf="!isLoadingChargebacks">
        
        <!-- 4 CARTES STATISTIQUES CHARGEBACK -->
        <div class="chargeback-stats-grid">
          <div class="chargeback-stat-card total">
            <div class="stat-icon">ğŸ’³</div>
            <div class="stat-content">
              <div class="stat-value">{{ chargebackStats?.total || 0 }}</div>
              <div class="stat-label">Total Chargebacks</div>
              <div class="stat-sublabel">Toutes phases confondues</div>
            </div>
            <div class="stat-indicator"></div>
          </div>

          <div class="chargeback-stat-card in-progress">
            <div class="stat-icon">â³</div>
            <div class="stat-content">
              <div class="stat-value">{{ chargebackStats?.enCours || 0 }}</div>
              <div class="stat-label">En Cours</div>
              <div class="stat-sublabel">NÃ©cessitent une action</div>
            </div>
            <div class="stat-indicator"></div>
          </div>

          <div class="chargeback-stat-card finalized">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
              <div class="stat-value">{{ chargebackStats?.finalises || 0 }}</div>
              <div class="stat-label">FinalisÃ©s</div>
              <div class="stat-sublabel">Processus terminÃ©s</div>
            </div>
            <div class="stat-indicator"></div>
          </div>

          <div class="chargeback-stat-card urgent">
            <div class="stat-icon urgent-icon">âš ï¸</div>
            <div class="stat-content">
              <div class="stat-value">{{ chargebackStats?.urgents || 0 }}</div>
              <div class="stat-label">Urgents</div>
              <div class="stat-sublabel">Deadline < 3 jours</div>
            </div>
            <div class="stat-indicator urgent-indicator"></div>
          </div>
        </div>

        <!-- MONTANT TOTAL SECTION -->
        <div class="chargeback-amount-section" *ngIf="chargebackStats?.montantTotal">
          <div class="amount-card">
            <div class="amount-icon">ğŸ’°</div>
            <div class="amount-content">
              <div class="amount-label">Montant Total ContestÃ©</div>
              <div class="amount-value">{{ formatChargebackCurrency(chargebackStats?.montantTotal || 0) }}</div>
              <div class="amount-sublabel">Tous chargebacks confondus</div>
            </div>
          </div>
        </div>

        <!-- FILTRES AVANCÃ‰S CHARGEBACK -->
        <!-- âœ… NOUVEAU : NAVIGATION ENTRE Ã‰MIS ET REÃ‡US -->
<div class="chargeback-tabs" *ngIf="chargebacks.length > 0">
  <div class="tabs-navigation">
    <button class="tab-button" 
            [class.active]="chargebackActiveSubTab === 'emis'"
            (click)="setChargebackSubTab('emis')">
      ğŸ§ Chargebacks Ã‰mis ({{ chargebacksEmis.length }})
      <small>Vous Ãªtes Ã©metteur</small>
    </button>
    <button class="tab-button" 
            [class.active]="chargebackActiveSubTab === 'recus'"
            (click)="setChargebackSubTab('recus')">
      ğŸª Chargebacks ReÃ§us ({{ chargebacksRecus.length }})
      <small>Vous Ãªtes acquÃ©reur</small>
    </button>
  </div>
</div>

<!-- FILTRES AVANCÃ‰S CHARGEBACK Ã‰MIS -->
<div class="chargeback-filters" *ngIf="chargebackActiveSubTab === 'emis' && chargebacksEmis.length > 0">
  <h4>ğŸ” Filtres Chargebacks Ã‰mis</h4>
  
  <div class="filters-grid">
    <!-- Recherche textuelle -->
    <div class="filter-group">
      <label>ğŸ” Recherche</label>
      <input type="text" 
             [(ngModel)]="chargebackFiltersEmis.texteRecherche" 
             (ngModelChange)="filterChargebacksEmis()" 
             placeholder="RÃ©fÃ©rence, montant, description..." 
             class="filter-input">
    </div>

    <!-- Filtre phase -->
    <div class="filter-group">
      <label>ğŸ“Š Phase</label>
      <select [(ngModel)]="chargebackFiltersEmis.phase" 
              (change)="filterChargebacksEmis()" 
              class="filter-select">
        <option value="">Toutes les phases</option>
        <option value="CHARGEBACK_INITIAL">ğŸ”µ Chargeback Initial</option>
        <option value="REPRESENTATION">ğŸŸ¡ ReprÃ©sentation</option>
        <option value="PRE_ARBITRAGE">ğŸŸ  PrÃ©-Arbitrage</option>
        <option value="ARBITRAGE">ğŸ”´ Arbitrage</option>
        <option value="FINALISE">âœ… FinalisÃ©</option>
      </select>
    </div>

    <!-- Filtre urgent -->
    <div class="filter-group">
      <label class="checkbox-label">
        <input type="checkbox" 
               [(ngModel)]="chargebackFiltersEmis.urgent" 
               (change)="filterChargebacksEmis()" 
               class="filter-checkbox">
        âš ï¸ Urgents uniquement
      </label>
    </div>

    <!-- Actions filtres -->
    <div class="filter-actions">
      <button (click)="clearChargebackFiltersEmis()" class="btn-clear-filters">
        ğŸ—‘ï¸ Effacer
      </button>
    </div>
  </div>
</div>

<!-- FILTRES AVANCÃ‰S CHARGEBACK REÃ‡US -->
<div class="chargeback-filters" *ngIf="chargebackActiveSubTab === 'recus' && chargebacksRecus.length > 0">
  <h4>ğŸ” Filtres Chargebacks ReÃ§us</h4>
  
  <div class="filters-grid">
    <!-- Recherche textuelle -->
    <div class="filter-group">
      <label>ğŸ” Recherche</label>
      <input type="text" 
             [(ngModel)]="chargebackFiltersRecus.texteRecherche" 
             (ngModelChange)="filterChargebacksRecus()" 
             placeholder="RÃ©fÃ©rence, montant, description..." 
             class="filter-input">
    </div>

    <!-- Filtre phase -->
    <div class="filter-group">
      <label>ğŸ“Š Phase</label>
      <select [(ngModel)]="chargebackFiltersRecus.phase" 
              (change)="filterChargebacksRecus()" 
              class="filter-select">
        <option value="">Toutes les phases</option>
        <option value="CHARGEBACK_INITIAL">ğŸ”µ Chargeback Initial</option>
        <option value="REPRESENTATION">ğŸŸ¡ ReprÃ©sentation</option>
        <option value="PRE_ARBITRAGE">ğŸŸ  PrÃ©-Arbitrage</option>
        <option value="ARBITRAGE">ğŸ”´ Arbitrage</option>
        <option value="FINALISE">âœ… FinalisÃ©</option>
      </select>
    </div>

    <!-- Filtre urgent -->
    <div class="filter-group">
      <label class="checkbox-label">
        <input type="checkbox" 
               [(ngModel)]="chargebackFiltersRecus.urgent" 
               (change)="filterChargebacksRecus()" 
               class="filter-checkbox">
        âš ï¸ Urgents uniquement
      </label>
    </div>

    <!-- Actions filtres -->
    <div class="filter-actions">
      <button (click)="clearChargebackFiltersRecus()" class="btn-clear-filters">
        ğŸ—‘ï¸ Effacer
      </button>
    </div>
  </div>
</div>

        <!-- TABLE CHARGEBACKS -->
        <!-- =============================================== -->
<!-- ğŸ§ TABLE CHARGEBACKS Ã‰MIS (VOUS ÃŠTES Ã‰METTEUR) -->
<!-- =============================================== -->
<div class="chargeback-table-container" *ngIf="chargebackActiveSubTab === 'emis' && chargebacksEmis.length > 0">
  <h4>ğŸ§ Chargebacks Ã‰mis ({{ filteredChargebacksEmis.length }})</h4>
  <p class="subsection-description">Vous Ãªtes la <strong>banque Ã©mettrice</strong> - Actions disponibles : Second Presentment, Arbitrage, Annulation</p>
  
  <div class="table-responsive">
    <table class="chargeback-table emis-table">
      <thead>
        <tr>
          <th>RÃ©f Transaction</th>
          <th>Banque AcquÃ©reuse</th>
          <th>Montant ContestÃ©</th>
          <th>Phase Actuelle</th>
          <th>Deadline</th>
          <th>CrÃ©Ã© le</th>
          <th>Actions Ã‰metteur</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cb of paginatedChargebacksEmis" 
            [class.urgent-row]="isChargebackUrgent(cb)"
            [class.finalized-row]="cb.phaseActuelle === 'FINALISE'"
            class="emis-row">
          
          <!-- RÃ©fÃ©rence Transaction -->
          <td data-label="RÃ©f Transaction">
            <div class="transaction-ref">
              <strong>{{ cb.transaction?.reference || 'N/A' }}</strong>
              <small class="chargeback-id">CB #{{ cb.id }}</small>
            </div>
          </td>

          <!-- Banque AcquÃ©reuse -->
          <td data-label="Banque AcquÃ©reuse">
            <div class="bank-info">
              <strong>{{ cb.transaction?.banqueAcquereuse?.nom || 'N/A' }}</strong>
              <small>ğŸª Doit rÃ©pondre</small>
            </div>
          </td>

          <!-- Montant ContestÃ© -->
          <td data-label="Montant">
            <div class="amount-cell">
              <span class="amount-value">{{ formatChargebackCurrency(cb.montantConteste) }}</span>
            </div>
          </td>

          <!-- Phase Actuelle -->
          <td data-label="Phase">
            <span class="phase-badge emis-phase" 
                  [class]="'phase-' + (cb.phaseActuelle || '').toLowerCase().replace('_', '-')">
              {{ getPhaseLabel(cb.phaseActuelle) }}
            </span>
          </td>

          <!-- Deadline -->
          <td data-label="Deadline">
            <div class="deadline-cell">
              <span class="deadline-date">{{ formatChargebackDate(cb.deadlineActuelle) }}</span>
              <div class="deadline-countdown" 
                   [class.urgent-countdown]="getJoursRestants(cb.deadlineActuelle) <= 3">
                <small>{{ getJoursRestants(cb.deadlineActuelle || '') }} jour(s)</small>
              </div>
            </div>
          </td>

          <!-- CrÃ©Ã© le -->
          <td data-label="CrÃ©Ã© le">
            <div class="created-date">
              <span>{{ formatChargebackDate(cb.dateCreation) }}</span>
              <small>Par: {{ nomEmploye }}</small>
            </div>
          </td>

          <!-- Actions Ã‰metteur -->
          <td data-label="Actions">
            <div class="action-buttons">
              
              <!-- Voir dÃ©tails -->
              <button class="btn-action btn-view" 
                      (click)="openHistoryModal(cb)"
                      title="Voir les dÃ©tails complets du chargeback">
                ğŸ‘ï¸ DÃ©tails
              </button>

              <!-- Second Presentment (Ã‰metteur seulement) -->
              <button *ngIf="canSecondPresentment(cb)" 
                      class="btn-action btn-second-presentment" 
                      (click)="openSecondPresentmentModal(cb)"
                      title="Second presentment">
                âš¡ Second Presentment
              </button>

              <!-- Arbitrage (Ã‰metteur seulement) -->
              <button *ngIf="canDemanderArbitrage(cb)" 
                      class="btn-action btn-arbitrage" 
                      (click)="openArbitrageModal(cb)"
                      title="Demander arbitrage">
                âš–ï¸ Arbitrage
              </button>

              <!-- Annuler (Ã‰metteur seulement) -->
              <button *ngIf="canAnnuler(cb)" 
                      class="btn-action btn-cancel" 
                      (click)="openCancellationModal(cb)"
                      title="Annuler le chargeback">
                ğŸš« Annuler
              </button>

              <!-- Upload justificatifs -->
              <button *ngIf="cb.phaseActuelle !== 'FINALISE'" 
                      class="btn-action btn-upload" 
                      (click)="openJustificatifsModal(cb)"
                      title="Ajouter des justificatifs">
                ğŸ“ Fichiers
              </button>
            </div>
          </td>
        </tr>

        <!-- Ligne vide si aucun rÃ©sultat -->
        <tr *ngIf="paginatedChargebacksEmis.length === 0" class="no-data-row">
          <td colspan="7">
            <div class="no-data-content">
              <div class="no-data-icon">ğŸ”</div>
              <p><strong>Aucun chargeback Ã©mis trouvÃ© avec ces critÃ¨res.</strong></p>
              <button (click)="clearChargebackFiltersEmis()" class="btn-clear-inline">
                Effacer les filtres
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- =============================================== -->
<!-- ğŸª TABLE CHARGEBACKS REÃ‡US (VOUS ÃŠTES ACQUÃ‰REUR) -->
<!-- =============================================== -->
<div class="chargeback-table-container" *ngIf="chargebackActiveSubTab === 'recus' && chargebacksRecus.length > 0">
  <h4>ğŸª Chargebacks ReÃ§us ({{ filteredChargebacksRecus.length }})</h4>
  <p class="subsection-description">Vous Ãªtes la <strong>banque acquÃ©reuse</strong> - Actions disponibles : ReprÃ©sentation, Acceptation, Contestation</p>
  
  <div class="table-responsive">
    <table class="chargeback-table recus-table">
      <thead>
        <tr>
          <th>RÃ©f Transaction</th>
          <th>Banque Ã‰mettrice</th>
          <th>Montant ContestÃ©</th>
          <th>Phase Actuelle</th>
          <th>Deadline</th>
          <th>ReÃ§u le</th>
          <th>Actions AcquÃ©reur</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cb of paginatedChargebacksRecus" 
            [class.urgent-row]="isChargebackUrgent(cb)"
            [class.finalized-row]="cb.phaseActuelle === 'FINALISE'"
            class="recus-row">
          
          <!-- RÃ©fÃ©rence Transaction -->
          <td data-label="RÃ©f Transaction">
            <div class="transaction-ref">
              <strong>{{ cb.transaction?.reference || 'N/A' }}</strong>
              <small class="chargeback-id">CB #{{ cb.id }}</small>
            </div>
          </td>

          <!-- Banque Ã‰mettrice -->
          <td data-label="Banque Ã‰mettrice">
            <div class="bank-info">
              <strong>{{ cb.transaction?.banqueEmettrice?.nom || 'N/A' }}</strong>
              <small>ğŸ§ A initiÃ© le chargeback</small>
            </div>
          </td>

          <!-- Montant ContestÃ© -->
          <td data-label="Montant">
            <div class="amount-cell">
              <span class="amount-value">{{ formatChargebackCurrency(cb.montantConteste) }}</span>
            </div>
          </td>

          <!-- Phase Actuelle -->
          <td data-label="Phase">
            <span class="phase-badge recus-phase" 
                  [class]="'phase-' + (cb.phaseActuelle || '').toLowerCase().replace('_', '-')">
              {{ getPhaseLabel(cb.phaseActuelle) }}
            </span>
          </td>

          <!-- Deadline -->
          <td data-label="Deadline">
            <div class="deadline-cell">
              <span class="deadline-date">{{ formatChargebackDate(cb.deadlineActuelle) }}</span>
              <div class="deadline-countdown" 
                   [class.urgent-countdown]="getJoursRestants(cb.deadlineActuelle) <= 3">
                <small>{{ getJoursRestants(cb.deadlineActuelle || '') }} jour(s)</small>
              </div>
            </div>
          </td>

          <!-- ReÃ§u le -->
          <td data-label="ReÃ§u le">
            <div class="received-date">
              <span>{{ formatChargebackDate(cb.dateCreation) }}</span>
            </div>
          </td>

          <!-- Actions AcquÃ©reur -->
          <td data-label="Actions">
            <div class="action-buttons">
              
              <!-- Voir dÃ©tails -->
              <button class="btn-action btn-view" 
                      (click)="openHistoryModal(cb)"
                      title="Voir les dÃ©tails complets du chargeback">
                ğŸ‘ï¸ DÃ©tails
              </button>

              <!-- ReprÃ©sentation (AcquÃ©reur seulement) -->
              <button *ngIf="canRepresenter(cb)" 
                      class="btn-action btn-represent" 
                      (click)="openRepresentationModal(cb)"
                      title="Traiter la reprÃ©sentation">
                ğŸ“ ReprÃ©senter
              </button>

              <!-- Upload justificatifs -->
              <button *ngIf="cb.phaseActuelle !== 'FINALISE'" 
                      class="btn-action btn-upload" 
                      (click)="openJustificatifsModal(cb)"
                      title="Ajouter des justificatifs">
                ğŸ“ Fichiers
              </button>
            </div>
          </td>
        </tr>

        <!-- Ligne vide si aucun rÃ©sultat -->
        <tr *ngIf="paginatedChargebacksRecus.length === 0" class="no-data-row">
          <td colspan="7">
            <div class="no-data-content">
              <div class="no-data-icon">ğŸ”</div>
              <p><strong>Aucun chargeback reÃ§u trouvÃ© avec ces critÃ¨res.</strong></p>
              <button (click)="clearChargebackFiltersRecus()" class="btn-clear-inline">
                Effacer les filtres
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- MESSAGE SI AUCUN CHARGEBACK -->
<div *ngIf="chargebackActiveSubTab === 'emis' && chargebacksEmis.length === 0" class="no-chargeback-content">
  <div class="no-data-icon">ğŸ’³</div>
  <p><strong>Aucun chargeback Ã©mis pour le moment.</strong></p>
  <p>Les chargebacks que vous initiez apparaÃ®tront ici.</p>
</div>

<div *ngIf="chargebackActiveSubTab === 'recus' && chargebacksRecus.length === 0" class="no-chargeback-content">
  <div class="no-data-icon">ğŸª</div>
  <p><strong>Aucun chargeback reÃ§u pour le moment.</strong></p>
  <p>Les chargebacks que les autres banques vous envoient apparaÃ®tront ici.</p>
</div>

        <!-- PAGINATION CHARGEBACK -->
        <div class="chargeback-pagination" *ngIf="chargebackTotalPages > 1">
          <button (click)="goToChargebackPage(chargebackCurrentPage - 1)" 
                  [disabled]="!canGoToChargebackPrevious" 
                  class="pagination-btn">
            â€¹ PrÃ©cÃ©dent
          </button>
          
          <button *ngFor="let page of chargebackPaginationArray" 
                  [class.active]="chargebackCurrentPage === page"
                  (click)="goToChargebackPage(page)"
                  class="pagination-btn">
            {{ page }}
          </button>
          
          <button (click)="goToChargebackPage(chargebackCurrentPage + 1)" 
                  [disabled]="!canGoToChargebackNext" 
                  class="pagination-btn">
            Suivant â€º
          </button>
        </div>

        <!-- INFO PAGINATION CHARGEBACK -->
        <div class="chargeback-pagination-info" *ngIf="filteredChargebacks.length > 0">
          Affichage de {{ (chargebackCurrentPage - 1) * chargebackItemsPerPage + 1 }} Ã  
          {{ getChargebackMaxDisplayed() }} 
          sur {{ filteredChargebacks.length }} chargebacks
        </div>

        <!-- MESSAGE SI AUCUN CHARGEBACK -->
        <div *ngIf="chargebacks.length === 0" class="no-chargeback-content">
          <div class="no-data-icon">ğŸ’³</div>
          <p><strong>Aucun chargeback initiÃ© pour le moment.</strong></p>
          <p>Les chargebacks que vous initiez pour les transactions litigieuses apparaÃ®tront ici.</p>
          <div class="chargeback-info">
            <h4>Pour initier un chargeback :</h4>
            <ol>
              <li>Allez dans l'onglet "ğŸ“Š Transactions"</li>
              <li>Identifiez une transaction litigieuse oÃ¹ votre banque est <strong>Ã©mettrice</strong></li>
              <li>Cliquez sur le bouton "ğŸ’³ Chargeback" dans les actions</li>
              <li>Remplissez le formulaire d'initiation</li>
            </ol>
          </div>
        </div>

      </div>
    </div>

    <!-- SECTION DE RÃ‰SUMÃ‰ -->
    <div class="summary-section">
      <h3>ğŸ“‹ RÃ©sumÃ© des activitÃ©s (RÃ¨gles mÃ©tier appliquÃ©es)</h3>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-icon">ğŸ“Š</div>
          <div class="summary-content">
            <div class="summary-value">{{ totalSignalableTransactions }}/{{ totalTransactions }}</div>
            <div class="summary-label">Transactions signalables</div>
          </div>
        </div>
        
        <div class="summary-card">
          <div class="summary-icon">ğŸš©</div>
          <div class="summary-content">
            <div class="summary-value">{{ litigesAcquereur.length }}</div>
            <div class="summary-label">Litiges Ã©mis</div>
          </div>
        </div>
        
        <div class="summary-card">
          <div class="summary-icon">ğŸš¨</div>
          <div class="summary-content">
            <div class="summary-value">{{ litigesRecus.length }}</div>
            <div class="summary-label">Litiges reÃ§us</div>
          </div>
        </div>
        
        <div class="summary-card chargeback-summary">
          <div class="summary-icon">ğŸ’³</div>
          <div class="summary-content">
            <div class="summary-value">{{ chargebacks.length || 0 }}</div>
            <div class="summary-label">Chargebacks</div>
          </div>
        </div>
        
        <div class="summary-card">
          <div class="summary-icon">ğŸ””</div>
          <div class="summary-content">
            <div class="summary-value">{{ unreadNotifications.length }}</div>
            <div class="summary-label">Notifications</div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <!-- MODAL DÃ‰TAILS LITIGE -->
  <div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeLitigeDetails()">
    <div class="modal-details" (click)="$event.stopPropagation()">
      
      <div class="modal-header">
        <h3>ğŸ” DÃ©tails complets du litige</h3>
        <button class="modal-close" (click)="closeLitigeDetails()">âœ•</button>
      </div>

      <div class="modal-body">
        
        <div *ngIf="isLoadingDetails" class="modal-loader">
          <div class="spinner"></div>
          <p>Chargement des dÃ©tails...</p>
        </div>

        <div *ngIf="detailsError" class="modal-error">
          <div class="error-icon">âš ï¸</div>
          <p>{{ detailsError }}</p>
          <button class="btn-retry" (click)="openLitigeDetails(selectedLitigeDetails?.id || 0)">
            ğŸ”„ RÃ©essayer
          </button>
        </div>

        <div *ngIf="selectedLitigeDetails && !isLoadingDetails" class="details-content">
          
          <div class="details-section">
            <h4>ğŸ“‹ Informations du litige</h4>
            <div class="details-grid">
              <div class="detail-item">
                <span class="detail-label">ID Litige :</span>
                <span class="detail-value">#{{ selectedLitigeDetails.id }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Type :</span>
                <span class="detail-value">{{ selectedLitigeDetails.type }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Statut :</span>
                <span class="detail-value status-badge" 
                      [class]="'status-' + (selectedLitigeDetails.statut || '').toLowerCase()">
                  {{ selectedLitigeDetails.statut }}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">PrioritÃ© :</span>
                <span class="detail-value priority-badge" 
                      [class]="getPriorityClass(selectedLitigeDetails.priorite)">
                  {{ selectedLitigeDetails.priorite }}
                </span>
              </div>
            </div>
          </div>

          <div class="details-section">
            <h4>â° Informations temporelles</h4>
            <div class="details-grid">
              <div class="detail-item full-width">
                <span class="detail-label">Date et heure de crÃ©ation :</span>
                <span class="detail-value datetime-complete">
                  {{ formatDateTimeComplete(selectedLitigeDetails.dateCreation) }}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">DurÃ©e depuis crÃ©ation :</span>
                <span class="detail-value">
                  {{ formatDureeDepuisCreation(selectedLitigeDetails.dureeDepuisCreationMinutes) }}
                </span>
              </div>
            </div>
          </div>

          <div class="details-section">
            <h4>ğŸ¦ Origine du litige</h4>
            <div class="details-grid">
              <div class="detail-item">
                <span class="detail-label">Banque dÃ©clarante :</span>
                <span class="detail-value">{{ selectedLitigeDetails.banqueDeclaranteNom }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">CrÃ©Ã© par :</span>
                <span class="detail-value">{{ selectedLitigeDetails.utilisateurCreateur }}</span>
              </div>
            </div>
            <div class="detail-item full-width">
              <span class="detail-label">Description :</span>
              <span class="detail-value description">{{ selectedLitigeDetails.description }}</span>
            </div>
          </div>

          <div class="details-section" *ngIf="selectedLitigeDetails.transaction">
            <h4>ğŸ’³ DÃ©tails de la transaction associÃ©e</h4>
            <div class="transaction-details">
              <div class="details-grid">
                <div class="detail-item">
                  <span class="detail-label">RÃ©fÃ©rence :</span>
                  <span class="detail-value reference">{{ selectedLitigeDetails.transaction.reference }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Montant :</span>
                  <span class="detail-value amount">{{ formatCurrencyFromNumber(selectedLitigeDetails.transaction.montant) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Type :</span>
                  <span class="detail-value">{{ selectedLitigeDetails.transaction.type }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Date transaction :</span>
                  <span class="detail-value">{{ formatDateOnly(selectedLitigeDetails.transaction.dateTransaction) }}</span>
                </div>
              </div>

              <div class="bank-details" *ngIf="selectedLitigeDetails.transaction.banqueEmettrice || selectedLitigeDetails.transaction.banqueAcquereuse">
                <div class="bank-item" *ngIf="selectedLitigeDetails.transaction.banqueEmettrice">
                  <h5>ğŸ§ Banque Ã‰mettrice</h5>
                  <p><strong>{{ selectedLitigeDetails.transaction.banqueEmettrice.nom }}</strong></p>
                  <small>Code: {{ selectedLitigeDetails.transaction.banqueEmettrice.code }}</small>
                </div>
                <div class="bank-item" *ngIf="selectedLitigeDetails.transaction.banqueAcquereuse">
                  <h5>ğŸª Banque AcquÃ©reuse</h5>
                  <p><strong>{{ selectedLitigeDetails.transaction.banqueAcquereuse.nom }}</strong></p>
                  <small>Code: {{ selectedLitigeDetails.transaction.banqueAcquereuse.code }}</small>
                </div>
              </div>

              <div class="satim-details" *ngIf="selectedLitigeDetails.transaction.satimData">
                <h5>ğŸ“¡ DonnÃ©es SATIM</h5>
                <div class="details-grid satim-grid">
                  <div class="detail-item">
                    <span class="detail-label">Code SATIM :</span>
                    <span class="detail-value">{{ selectedLitigeDetails.transaction.satimData.strCode }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Terminal :</span>
                    <span class="detail-value">{{ selectedLitigeDetails.transaction.satimData.strTermIden }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeLitigeDetails()">
          âœ• Fermer
        </button>
        <button 
          *ngIf="selectedLitigeDetails?.peutEtreModifie" 
          class="btn-primary"
          title="Modifier ce litige">
          ğŸ“ Modifier
        </button>
      </div>

    </div>
  </div>

  <!-- MODAL DÃ‰TAILS TRANSACTION -->
  <div class="modal-overlay" *ngIf="showTransactionDetailsModal" (click)="closeTransactionDetails()">
    <div class="modal-details" (click)="$event.stopPropagation()">
      
      <div class="modal-header">
        <h3>ğŸ“„ DÃ©tails complets de la transaction</h3>
        <button class="modal-close" (click)="closeTransactionDetails()">âœ•</button>
      </div>

      <div class="modal-body">
        
        <div *ngIf="isLoadingTransactionDetails" class="modal-loader">
          <div class="spinner"></div>
          <p>Chargement des dÃ©tails de la transaction...</p>
        </div>

        <div *ngIf="transactionDetailsError" class="modal-error">
          <div class="error-icon">âš ï¸</div>
          <p>{{ transactionDetailsError }}</p>
          <button class="btn-retry" (click)="openTransactionDetails(selectedTransactionDetails?.id || 0)">
            ğŸ”„ RÃ©essayer
          </button>
        </div>

        <div *ngIf="selectedTransactionDetails && !isLoadingTransactionDetails" class="details-content">
          
          <div class="details-section">
            <h4>ğŸ’³ Informations de la transaction</h4>
            <div class="details-grid">
              <div class="detail-item">
                <span class="detail-label">ID Transaction :</span>
                <span class="detail-value">#{{ selectedTransactionDetails.id }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">RÃ©fÃ©rence :</span>
                <span class="detail-value reference">{{ selectedTransactionDetails.reference }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Montant :</span>
                <span class="detail-value amount">{{ formatCurrencyFromNumber(selectedTransactionDetails.montant) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Type :</span>
                <span class="detail-value">{{ selectedTransactionDetails.type }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Statut :</span>
                <span class="detail-value status-badge">{{ selectedTransactionDetails.statut }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Date transaction :</span>
                <span class="detail-value">{{ formatDateOnly(selectedTransactionDetails.dateTransaction) }}</span>
              </div>
            </div>
          </div>

          <div class="details-section">
            <h4>ğŸ¦ Informations bancaires</h4>
            <div class="bank-details">
              <div class="bank-item" *ngIf="selectedTransactionDetails.banqueEmettrice">
                <h5>ğŸ§ Banque Ã‰mettrice</h5>
                <p><strong>{{ selectedTransactionDetails.banqueEmettrice.nom }}</strong></p>
                <small>Code: {{ selectedTransactionDetails.banqueEmettrice.code }}</small>
              </div>
              <div class="bank-item" *ngIf="selectedTransactionDetails.banqueAcquereuse">
                <h5>ğŸª Banque AcquÃ©reuse</h5>
                <p><strong>{{ selectedTransactionDetails.banqueAcquereuse.nom }}</strong></p>
                <small>Code: {{ selectedTransactionDetails.banqueAcquereuse.code }}</small>
              </div>
            </div>
          </div>

          <div class="details-section" *ngIf="selectedTransactionDetails.satimData">
            <h4>ğŸ“¡ DonnÃ©es SATIM</h4>
            <div class="satim-details">
              <div class="details-grid satim-grid">
                <div class="detail-item">
                  <span class="detail-label">Code SATIM :</span>
                  <span class="detail-value">{{ selectedTransactionDetails.satimData.strCode }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Terminal :</span>
                  <span class="detail-value">{{ selectedTransactionDetails.satimData.strTermIden }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="details-section" *ngIf="selectedTransactionDetails.litige">
            <h4>ğŸš© Litige associÃ©</h4>
            <div class="details-grid">
              <div class="detail-item">
                <span class="detail-label">ID Litige :</span>
                <span class="detail-value">#{{ selectedTransactionDetails.litige.id }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Type de litige :</span>
                <span class="detail-value">{{ selectedTransactionDetails.litige.type }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Banque dÃ©clarante :</span>
                <span class="detail-value">{{ selectedTransactionDetails.litige.banqueDeclaranteNom }}</span>
              </div>
              <div class="detail-item full-width">
                <span class="detail-label">Description :</span>
                <span class="detail-value description">{{ selectedTransactionDetails.litige.description }}</span>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeTransactionDetails()">
          âœ• Fermer
        </button>
      </div>

    </div>
  </div>
  <!-- MODAL INITIATION CHARGEBACK -->
  <div class="modal-overlay" *ngIf="showInitiationChargebackModal" (click)="closeChargebackModal()">
    <div class="modal-chargeback" (click)="$event.stopPropagation()">
      
      <!-- HEADER MODAL -->
      <div class="modal-header-chargeback">
        <div class="modal-title-section">
          <h3>ğŸ’³ Initier un Chargeback</h3>
          <p class="modal-subtitle">
            Transaction: <strong>{{ selectedTransactionForChargeback?.reference }}</strong>
          </p>
        </div>
        <button class="modal-close-btn" (click)="closeChargebackModal()">âœ•</button>
      </div>

      <!-- BODY MODAL -->
      <div class="modal-body-chargeback">
        
        <!-- INFORMATIONS TRANSACTION -->
        <div class="transaction-info-section">
          <h4>ğŸ“„ Informations de la transaction</h4>
          <div class="transaction-summary">
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">RÃ©fÃ©rence:</span>
                <span class="info-value">{{ selectedTransactionForChargeback?.reference }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Montant:</span>
                <span class="info-value amount">{{ formatCurrency(selectedTransactionForChargeback?.montant) }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Date:</span>
                <span class="info-value">{{ formatDate(selectedTransactionForChargeback?.dateTransaction) }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Type:</span>
                <span class="info-value">{{ selectedTransactionForChargeback?.type }}</span>
              </div>
            </div>
            
            <!-- Banques -->
            <div class="banks-summary" *ngIf="selectedTransactionForChargeback">
              <div class="bank-info">
                <span class="bank-label">ğŸ§ Banque Ã‰mettrice:</span>
                <span class="bank-name">{{ selectedTransactionForChargeback.banqueEmettrice?.nom || 'N/A' }}</span>
              </div>
              <div class="bank-info">
                <span class="bank-label">ğŸª Banque AcquÃ©reuse:</span>
                <span class="bank-name">{{ selectedTransactionForChargeback.banqueAcquereuse?.nom || 'N/A' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- FORMULAIRE CHARGEBACK -->
        <form class="chargeback-form" (ngSubmit)="initiateChargeback()">
          
          <!-- Motif obligatoire -->
          <div class="form-group required">
            <label for="motifChargeback">
              ğŸ“ Motif du chargeback <span class="required-star">*</span>
            </label>
            <textarea id="motifChargeback"
                      [(ngModel)]="chargebackForm.motifChargeback"
                      name="motifChargeback"
                      placeholder="DÃ©crivez le motif du chargeback (minimum 10 caractÃ¨res)..."
                      class="form-textarea"
                      rows="3"
                      required
                      minlength="10"></textarea>
            <small class="form-help">
              Minimum 10 caractÃ¨res. Soyez prÃ©cis et factuel.
            </small>
          </div>

          <!-- Description complÃ©mentaire -->
          <div class="form-group">
            <label for="description">
              ğŸ“‹ Description complÃ©mentaire
            </label>
            <textarea id="description"
                      [(ngModel)]="chargebackForm.description"
                      name="description"
                      placeholder="Informations supplÃ©mentaires (optionnel)..."
                      class="form-textarea"
                      rows="2"></textarea>
          </div>

          <!-- Montant contestÃ© -->
          <div class="form-group required">
            <label for="montantConteste">
              ğŸ’° Montant contestÃ© <span class="required-star">*</span>
            </label>
            <div class="amount-input-group">
              <input type="number"
                     id="montantConteste"
                     [(ngModel)]="chargebackForm.montantConteste"
                     name="montantConteste"
                     placeholder="0.00"
                     class="form-input amount-input"
                     min="0.01"
                     step="0.01"
                     required>
              <span class="currency-suffix">MAD</span>
            </div>
            <small class="form-help">
              Montant maximum: {{ formatCurrency(selectedTransactionForChargeback?.montant) }}
            </small>
          </div>

          <!-- PrioritÃ© -->
          <div class="form-group">
            <label for="priorite">
              ğŸ¯ PrioritÃ© du chargeback
            </label>
            <select id="priorite"
                    [(ngModel)]="chargebackForm.priorite"
                    name="priorite"
                    class="form-select">
              <option value="NORMALE">ğŸŸ¢ Normale</option>
              <option value="HAUTE">ğŸŸ¡ Haute</option>
              <option value="URGENTE">ğŸ”´ Urgente</option>
            </select>
          </div>

          <!-- Case urgente -->
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox"
                     [(ngModel)]="chargebackForm.demandeUrgente"
                     name="demandeUrgente"
                     class="form-checkbox">
              âš ï¸ Demande de traitement urgent
            </label>
            <small class="form-help checkbox-help">
              Cochez si ce chargeback nÃ©cessite un traitement prioritaire
            </small>
          </div>

          <!-- Upload justificatifs -->
          <div class="form-group">
            <label for="justificatifs">
              ğŸ“ Justificatifs (optionnel)
            </label>
            <div class="file-upload-area">
              <input type="file"
                     id="justificatifs"
                     (change)="onJustificatifsSelected($event)"
                     class="file-input"
                     multipleaccept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
              <div class="file-upload-display">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">
                  <strong>Cliquez pour ajouter des fichiers</strong>
                  <small>PDF, Images, Documents Word acceptÃ©s</small>
                </div>
              </div>
            </div>
            
            <!-- Liste des fichiers sÃ©lectionnÃ©s -->
            <div class="selected-files" *ngIf="chargebackForm.justificatifs.length > 0">
              <h5>ğŸ“‚ Fichiers sÃ©lectionnÃ©s:</h5>
              <div class="file-list">
                <div *ngFor="let file of chargebackForm.justificatifs; let i = index" 
                     class="file-item">
                  <span class="file-icon">ğŸ“„</span>
                  <span class="file-name">{{ file.name }}</span>
                  <span class="file-size">({{ (file.size / 1024).toFixed(1) }} KB)</span>
                  <button type="button" 
                          class="remove-file-btn"
                          (click)="removeJustificatif(i)">âœ•</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Commentaire client -->
          <div class="form-group">
            <label for="commentaireClient">
              ğŸ’¬ Commentaire client
            </label>
            <textarea id="commentaireClient"
                      [(ngModel)]="chargebackForm.commentaireClient"
                      name="commentaireClient"
                      placeholder="Commentaires ou observations du client (optionnel)..."
                      class="form-textarea"
                      rows="2"></textarea>
          </div>

        </form>

        <!-- RÃ‰CAPITULATIF -->
        <div class="summary-section-modal">
          <h4>ğŸ“‹ RÃ©capitulatif</h4>
          <div class="summary-grid-modal">
            <div class="summary-item-modal">
              <span class="summary-label-modal">Transaction:</span>
              <span class="summary-value-modal">{{ selectedTransactionForChargeback?.reference }}</span>
            </div>
            <div class="summary-item-modal">
              <span class="summary-label-modal">Montant contestÃ©:</span>
              <span class="summary-value-modal amount">{{ formatChargebackCurrency(chargebackForm.montantConteste) }}</span>
            </div>
            <div class="summary-item-modal">
              <span class="summary-label-modal">PrioritÃ©:</span>
              <span class="summary-value-modal priority" [class]="'priority-' + chargebackForm.priorite.toLowerCase()">
                {{ chargebackForm.priorite }}
              </span>
            </div>
            <div class="summary-item-modal" *ngIf="chargebackForm.justificatifs.length > 0">
              <span class="summary-label-modal">Justificatifs:</span>
              <span class="summary-value-modal">{{ chargebackForm.justificatifs.length }} fichier(s)</span>
            </div>
          </div>
        </div>

      </div>

      <!-- FOOTER MODAL -->
      <div class="modal-footer-chargeback">
        <div class="footer-info">
          <small>
            âš ï¸ Une fois initiÃ©, le chargeback suivra le processus rÃ©glementaire bancaire.
          </small>
        </div>
        
        <div class="footer-actions">
          <button type="button" 
                  class="btn-secondary" 
                  (click)="closeChargebackModal()"
                  [disabled]="isInitiatingChargeback">
            âœ• Annuler
          </button>
          
          <button type="button" 
                  class="btn-primary chargeback-btn" 
                  (click)="initiateChargeback()"
                  [disabled]="isInitiatingChargeback || !isChargebackFormValid()">
            <span *ngIf="!isInitiatingChargeback">ğŸ’³ Initier Chargeback</span>
            <span *ngIf="isInitiatingChargeback">â³ Initiation en cours...</span>
          </button>
        </div>
      </div>

    </div>
  </div>
  <!-- MODAL REPRÃ‰SENTATION -->
  <div class="modal-overlay" *ngIf="showRepresentationModal">
    <div class="modal-chargeback-action">
      <div class="modal-header">
        <h3>ğŸ“ Traiter la ReprÃ©sentation</h3>
        <button (click)="closeRepresentationModal()">âœ•</button>
      </div>
      
      <div class="modal-body">
        <!-- Info chargeback -->
        <div class="chargeback-summary">
          <h4>ğŸ’³ Chargeback #{{ selectedChargebackForAction?.id }}</h4>
          <p>Transaction: {{ selectedChargebackForAction?.transaction?.reference }}</p>
          <p>Montant: {{ formatChargebackCurrency(selectedChargebackForAction?.montantConteste) }}</p>
        </div>
        
        <!-- Formulaire reprÃ©sentation -->
        <form (ngSubmit)="processRepresentation()">
          <!-- Type de rÃ©ponse -->
          <div class="form-group required">
            <label>Type de rÃ©ponse</label>
            <select [(ngModel)]="representationForm.typeReponse" name="typeReponse">
              <option value="ACCEPTATION_TOTALE">âœ… Acceptation Totale</option>
              <option value="ACCEPTATION_PARTIELLE">ğŸŸ¡ Acceptation Partielle</option>  
              <option value="CONTESTATION">âŒ Contestation</option>
            </select>
          </div>
          
          <!-- Montant acceptÃ© (si partielle) -->
          <div class="form-group" *ngIf="representationForm.typeReponse === 'ACCEPTATION_PARTIELLE'">
            <label>Montant acceptÃ©</label>
            <input type="number" [(ngModel)]="representationForm.montantAccepte" name="montantAccepte">
          </div>
          
          <!-- RÃ©ponse dÃ©taillÃ©e -->
          <div class="form-group required">
            <label>RÃ©ponse dÃ©taillÃ©e</label>
            <textarea [(ngModel)]="representationForm.reponseDetaillee" 
                      name="reponseDetaillee"
                      placeholder="DÃ©crivez votre position (min 20 caractÃ¨res)..."
                      rows="4" required minlength="20"></textarea>
          </div>
          
          <!-- Arguments de dÃ©fense -->
          <div class="form-group">
            <label>Arguments de dÃ©fense</label>
            <textarea [(ngModel)]="representationForm.argumentsDefense"
                      name="argumentsDefense" 
                      placeholder="Arguments juridiques et techniques..."
                      rows="3"></textarea>
          </div>
          
          <!-- Upload justificatifs -->
          <div class="form-group">
            <label>Justificatifs de dÃ©fense</label>
            <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                   (change)="onJustificatifsSelectedForPhase($event, 'REPRESENTATION')">
          </div>
          
          <!-- DÃ©lai supplÃ©mentaire -->
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="representationForm.demandeDelaiSupplementaire" name="demandeDelai">
              Demander un dÃ©lai supplÃ©mentaire
            </label>
            <input *ngIf="representationForm.demandeDelaiSupplementaire"
                   type="number" [(ngModel)]="representationForm.joursDelaiSupplementaire"
                   placeholder="Nombre de jours" min="1" max="30">
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeRepresentationModal()">Annuler</button>
        <button type="button" class="btn-primary" 
                (click)="processRepresentation()"
                [disabled]="!isFormValid('representation') || isProcessingRepresentation">
          <span *ngIf="!isProcessingRepresentation">ğŸ“ Envoyer ReprÃ©sentation</span>
          <span *ngIf="isProcessingRepresentation">â³ Traitement...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL SECOND PRESENTMENT -->
  <div class="modal-overlay" *ngIf="showSecondPresentmentModal">
    <div class="modal-chargeback-action">
      <div class="modal-header">
        <h3>âš¡ Second Presentment</h3>
        <button (click)="closeSecondPresentmentModal()">âœ•</button>
      </div>
      
      <div class="modal-body">
        <!-- Info chargeback -->
        <div class="chargeback-summary">
          <h4>ğŸ’³ Chargeback #{{ selectedChargebackForAction?.id }}</h4>
          <p>Transaction: {{ selectedChargebackForAction?.transaction?.reference }}</p>
        </div>
        
        <!-- Formulaire second presentment -->
        <form (ngSubmit)="processSecondPresentment()">
          <!-- Motif de rejet -->
          <div class="form-group required">
            <label>Motif de rejet</label>
            <textarea [(ngModel)]="secondPresentmentForm.motifRejet" 
                      name="motifRejet"
                      placeholder="Motif du rejet (min 20 caractÃ¨res)..."
                      rows="3" required minlength="20"></textarea>
          </div>
          
          <!-- RÃ©futation dÃ©taillÃ©e -->
          <div class="form-group required">
            <label>RÃ©futation dÃ©taillÃ©e</label>
            <textarea [(ngModel)]="secondPresentmentForm.refutationDetaillee"
                      name="refutationDetaillee" 
                      placeholder="RÃ©futation complÃ¨te (min 50 caractÃ¨res)..."
                      rows="4" required minlength="50"></textarea>
          </div>
          
          <!-- Arguments supplÃ©mentaires -->
          <div class="form-group">
            <label>Arguments supplÃ©mentaires</label>
            <textarea [(ngModel)]="secondPresentmentForm.argumentsSupplementaires"
                      name="argumentsSupplementaires"
                      placeholder="Arguments complÃ©mentaires..."
                      rows="3"></textarea>
          </div>
          
          <!-- Upload nouvelles preuves -->
          <div class="form-group">
            <label>Nouvelles preuves</label>
            <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                   (change)="onJustificatifsSelectedForPhase($event, 'SECOND_PRESENTMENT')">
          </div>
          
          <!-- Analyse technique -->
          <div class="form-group">
            <label>Analyse technique</label>
            <textarea [(ngModel)]="secondPresentmentForm.analyseTechnique"
                      name="analyseTechnique"
                      placeholder="Analyse technique dÃ©taillÃ©e..."
                      rows="3"></textarea>
          </div>
          
          <!-- Demande arbitrage -->
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="secondPresentmentForm.demandeArbitrage" name="demandeArbitrage">
              Demander l'arbitrage si rejetÃ©
            </label>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeSecondPresentmentModal()">Annuler</button>
        <button type="button" class="btn-primary" 
                (click)="processSecondPresentment()"
                [disabled]="!isFormValid('secondPresentment') || isProcessingSecondPresentment">
          <span *ngIf="!isProcessingSecondPresentment">âš¡ Envoyer Second Presentment</span>
          <span *ngIf="isProcessingSecondPresentment">â³ Traitement...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL ARBITRAGE -->
  <div class="modal-overlay" *ngIf="showArbitrageModal">
    <div class="modal-chargeback-action">
      <div class="modal-header">
        <h3>âš–ï¸ Demande d'Arbitrage</h3>
        <button (click)="closeArbitrageModal()">âœ•</button>
      </div>
      
      <div class="modal-body">
        <!-- Info chargeback -->
        <div class="chargeback-summary">
          <h4>ğŸ’³ Chargeback #{{ selectedChargebackForAction?.id }}</h4>
          <p>Transaction: {{ selectedChargebackForAction?.transaction?.reference }}</p>
        </div>
        
        <!-- Formulaire arbitrage -->
        <form (ngSubmit)="processArbitrage()">
          <!-- Justification demande -->
          <div class="form-group required">
            <label>Justification de la demande</label>
            <textarea [(ngModel)]="arbitrageForm.justificationDemande" 
                      name="justificationDemande"
                      placeholder="Justification complÃ¨te (min 50 caractÃ¨res)..."
                      rows="4" required minlength="50"></textarea>
          </div>
          
          <!-- Position de la banque -->
          <div class="form-group required">
            <label>Position de la banque</label>
            <textarea [(ngModel)]="arbitrageForm.positionBanque"
                      name="positionBanque" 
                      placeholder="Position officielle (min 30 caractÃ¨res)..."
                      rows="3" required minlength="30"></textarea>
          </div>
          
          <!-- Arguments clÃ©s -->
          <div class="form-group">
            <label>Arguments clÃ©s</label>
            <textarea placeholder="Arguments principaux sÃ©parÃ©s par des retours Ã  la ligne..."
                      rows="3"></textarea>
          </div>
          
          <!-- Upload documents finaux -->
          <div class="form-group">
            <label>Documents finaux</label>
            <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                   (change)="onJustificatifsSelectedForPhase($event, 'ARBITRAGE')">
          </div>
          
          <!-- CoÃ»t estimÃ© -->
          <div class="form-group">
            <label>CoÃ»t estimÃ©</label>
            <input type="number" [(ngModel)]="arbitrageForm.coutEstime" name="coutEstime"
                   placeholder="CoÃ»t en MAD" min="0">
          </div>
          
          <!-- PrioritÃ© -->
          <div class="form-group">
            <label>PrioritÃ©</label>
            <select [(ngModel)]="arbitrageForm.priorite" name="priorite">
              <option value="NORMALE">ğŸŸ¢ Normale</option>
              <option value="HAUTE">ğŸŸ¡ Haute</option>
              <option value="URGENTE">ğŸ”´ Urgente</option>
            </select>
          </div>
          
          <!-- Demande urgente -->
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="arbitrageForm.demandeUrgente" name="demandeUrgente">
              Demande urgente
            </label>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeArbitrageModal()">Annuler</button>
        <button type="button" class="btn-primary" 
                (click)="processArbitrage()"
                [disabled]="!isFormValid('arbitrage') || isProcessingArbitrage">
          <span *ngIf="!isProcessingArbitrage">âš–ï¸ Demander Arbitrage</span>
          <span *ngIf="isProcessingArbitrage">â³ Traitement...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL DÃ‰CISION ARBITRAGE -->
  <div class="modal-overlay" *ngIf="showDecisionArbitrageModal">
    <div class="modal-chargeback-action">
      <div class="modal-header">
        <h3>ğŸ›ï¸ DÃ©cision d'Arbitrage</h3>
        <button (click)="closeDecisionArbitrageModal()">âœ•</button>
      </div>
      
      <div class="modal-body">
        <!-- Info chargeback -->
        <div class="chargeback-summary">
          <h4>ğŸ’³ Chargeback #{{ selectedChargebackForAction?.id }}</h4>
          <p>Transaction: {{ selectedChargebackForAction?.transaction?.reference }}</p>
        </div>
        
        <!-- Formulaire dÃ©cision -->
        <form (ngSubmit)="processDecisionArbitrage()">
          <!-- DÃ©cision -->
          <div class="form-group required">
            <label>DÃ©cision</label>
            <select [(ngModel)]="decisionArbitrageForm.decision" name="decision">
              <option value="FAVORABLE_EMETTEUR">âœ… Favorable Ã  l'Ã‰metteur</option>
              <option value="FAVORABLE_ACQUEREUR">âœ… Favorable Ã  l'AcquÃ©reur</option>
            </select>
          </div>
          
          <!-- Motifs dÃ©cision -->
          <div class="form-group required">
            <label>Motifs de la dÃ©cision</label>
            <textarea [(ngModel)]="decisionArbitrageForm.motifsDecision" 
                      name="motifsDecision"
                      placeholder="Motifs dÃ©taillÃ©s (min 20 caractÃ¨res)..."
                      rows="4" required minlength="20"></textarea>
          </div>
          
          <!-- RÃ©partition frais -->
          <div class="form-group">
            <label>RÃ©partition des frais</label>
            <select [(ngModel)]="decisionArbitrageForm.repartitionFrais" name="repartitionFrais">
              <option value="PERDANT">ğŸ’¸ Ã€ la charge du perdant</option>
              <option value="EMETTEUR">ğŸ§ Ã€ la charge de l'Ã©metteur</option>
              <option value="ACQUEREUR">ğŸª Ã€ la charge de l'acquÃ©reur</option>
              <option value="PARTAGE">âš–ï¸ PartagÃ©s Ã©quitablement</option>
            </select>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeDecisionArbitrageModal()">Annuler</button>
        <button type="button" class="btn-primary" 
                (click)="processDecisionArbitrage()"
                [disabled]="!isFormValid('decisionArbitrage') || isProcessingDecision">
          <span *ngIf="!isProcessingDecision">ğŸ›ï¸ Rendre DÃ©cision</span>
          <span *ngIf="isProcessingDecision">â³ Traitement...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL ANNULATION -->
  <div class="modal-overlay" *ngIf="showCancellationModal">
    <div class="modal-chargeback-action">
      <div class="modal-header">
        <h3>ğŸš« Annuler le Chargeback</h3>
        <button (click)="closeCancellationModal()">âœ•</button>
      </div>
      
      <div class="modal-body">
        <!-- Info chargeback -->
        <div class="chargeback-summary">
          <h4>ğŸ’³ Chargeback #{{ selectedChargebackForAction?.id }}</h4>
          <p>Transaction: {{ selectedChargebackForAction?.transaction?.reference }}</p>
        </div>
        
        <!-- Formulaire annulation -->
        <form (ngSubmit)="processCancellation()">
          <!-- Motif annulation -->
          <div class="form-group required">
            <label>Motif d'annulation</label>
            <textarea [(ngModel)]="cancellationForm.motifAnnulation" 
                      name="motifAnnulation"
                      placeholder="Motif d'annulation (min 10 caractÃ¨res)..."
                      rows="3" required minlength="10"></textarea>
          </div>
          
          <!-- Impact client -->
          <div class="form-group">
            <label>Impact sur le client</label>
            <textarea [(ngModel)]="cancellationForm.impactClient"
                      name="impactClient"
                      placeholder="Impact sur le client..."
                      rows="2"></textarea>
          </div>
          
          <!-- Confirmation -->
          <div class="form-group">
            <div class="warning-box">
              âš ï¸ <strong>Attention :</strong> L'annulation du chargeback est dÃ©finitive et ne peut pas Ãªtre annulÃ©e.
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeCancellationModal()">Annuler</button>
        <button type="button" class="btn-danger" 
                (click)="processCancellation()"
                [disabled]="!isFormValid('cancellation') || isProcessingCancellation">
          <span *ngIf="!isProcessingCancellation">ğŸš« Confirmer Annulation</span>
          <span *ngIf="isProcessingCancellation">â³ Traitement...</span>
        </button>
      </div>
    </div>
  </div>
  <!-- MODAL HISTORIQUE -->
  <div class="modal-overlay" *ngIf="showHistoryModal">
  <div class="modal-history">
    <div class="modal-header">
      <h3>ğŸ“‹ Historique Complet</h3>
      <button (click)="closeHistoryModal()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <div class="chargeback-summary">
        <h4>ğŸ’³ Chargeback #{{ selectedChargebackForAction?.id }}</h4>
        <p>Transaction: {{ selectedChargebackForAction?.transaction?.reference }}</p>
        <p>Phase actuelle: {{ getPhaseLabel(selectedChargebackForAction?.phaseActuelle || '') }}</p>
      </div>
      
      <div class="timeline" *ngIf="!isLoadingHistory">
        <div class="timeline-item" *ngFor="let echange of chargebackHistory">
          <div class="timeline-marker" [class]="'marker-' + (echange.phaseLitige || 'UNKNOWN')">
            <i class="icon">{{ getPhaseIcon(echange.phaseLitige || '') }}</i>
          </div>
          <div class="timeline-content">
            <div class="timeline-header">
              <span class="timeline-phase">{{ getPhaseLabel(echange.phaseLitige || '') }}</span>
              <span class="timeline-date">{{ formatDateTime(echange.dateEchange || '') }}</span>
            </div>
            <div class="timeline-body">
              <p>{{ echange.contenu }}</p>
              <small>
                Par: {{ getAuteurName(echange) }} 
                ({{ getInstitutionName(echange) }})
              </small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="loading" *ngIf="isLoadingHistory">
        <div class="spinner"></div>
        <p>Chargement de l'historique...</p>
      </div>
      
      <div *ngIf="!isLoadingHistory && chargebackHistory.length === 0" class="no-history">
        <p>Aucun historique disponible pour ce chargeback.</p>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeHistoryModal()">Fermer</button>
    </div>
  </div>
</div>

  <!-- MODAL JUSTIFICATIFS -->
  <div class="modal-overlay" *ngIf="showJustificatifsModal">
    <div class="modal-justificatifs">
      <div class="modal-header">
        <h3>ğŸ“ Gestion des Justificatifs</h3>
        <button (click)="closeJustificatifsModal()">âœ•</button>
      </div>
      
      <div class="modal-body">
        <div class="chargeback-summary">
          <h4>ğŸ’³ Chargeback #{{ selectedChargebackForAction?.id }}</h4>
          <p>Transaction: {{ selectedChargebackForAction?.transaction?.reference }}</p>
        </div>
        
        <!-- Liste des justificatifs existants -->
        <div class="existing-justificatifs">
          <h4>ğŸ“‚ Justificatifs existants</h4>
          
          <div *ngIf="isLoadingJustificatifs" class="loading">
            <div class="spinner"></div>
            <p>Chargement des justificatifs...</p>
          </div>
          
          <div *ngIf="!isLoadingJustificatifs && selectedChargebackJustificatifs.length === 0" class="no-justificatifs">
            <p>Aucun justificatif pour ce chargeback.</p>
          </div>
          
          <div class="justificatifs-list" *ngIf="!isLoadingJustificatifs && selectedChargebackJustificatifs.length > 0">
            <div *ngFor="let justificatif of selectedChargebackJustificatifs" class="justificatif-item">
              <div class="justificatif-icon">ğŸ“„</div>
              <div class="justificatif-info">
  <strong>{{ justificatif.nomFichier }}</strong> <!-- âœ… CORRIGÃ‰ -->
  <small>Phase: {{ getPhaseLabel(justificatif.phaseLitige || '') }}</small> <!-- âœ… CORRIGÃ‰ -->
  <small>Taille: {{ formatFileSize(justificatif.tailleFichier) }}</small> <!-- âœ… CORRIGÃ‰ -->
</div>
              <div class="justificatif-actions">
                <button class="btn-download" (click)="downloadJustificatif(justificatif)">
                  ğŸ“¥ TÃ©lÃ©charger
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Upload nouveaux justificatifs -->
        <div class="new-justificatifs" *ngIf="selectedChargebackForAction?.phaseActuelle !== 'FINALISE'">
          <h4>ğŸ“ Ajouter des justificatifs</h4>
          
          <div class="file-upload-area">
            <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                   (change)="onJustificatifsSelectedForPhase($event, 'JUSTIFICATIFS_MODAL')"
                   class="file-input">
            <div class="file-upload-display">
              <div class="upload-icon">ğŸ“</div>
              <div class="upload-text">
                <strong>Cliquez pour ajouter des fichiers</strong>
                <small>PDF, Images, Documents Word acceptÃ©s</small>
              </div>
            </div>
          </div>
          
          <!-- Liste des nouveaux fichiers -->
          <div class="new-files" *ngIf="newJustificatifs.length > 0">
            <h5>ğŸ“‚ Nouveaux fichiers:</h5>
            <div class="file-list">
              <div *ngFor="let file of newJustificatifs; let i = index" class="file-item">
                <span class="file-icon">ğŸ“„</span>
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">({{ (file.size / 1024).toFixed(1) }} KB)</span>
                <button type="button" class="remove-file-btn" (click)="newJustificatifs.splice(i, 1)">âœ•</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeJustificatifsModal()">Fermer</button>
        <button *ngIf="newJustificatifs.length > 0" 
                class="btn-primary" 
                title="FonctionnalitÃ© Ã  implÃ©menter">
          ğŸ“ Sauvegarder Justificatifs
        </button>
      </div>
    </div>
  </div>

</div>
