<div class="admin-arbitrages-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Gestion des Arbitrages</h1>
      <button class="btn-refresh" (click)="refresh()" [disabled]="isLoading">
        üîÑ Actualiser
      </button>
    </div>
  </div>

  <!-- Dashboard Stats -->
  <div class="dashboard-stats" *ngIf="dashboard">
    <div class="stat-card">
      <h3>{{ dashboard.totalArbitrages }}</h3>
      <p>Total Arbitrages</p>
    </div>
    <div class="stat-card urgent">
      <h3>{{ dashboard.arbitragesEnAttente }}</h3>
      <p>En Attente</p>
    </div>
    <div class="stat-card active">
      <h3>{{ dashboard.arbitragesEnCours }}</h3>
      <p>En Cours</p>
    </div>
    <div class="stat-card completed">
      <h3>{{ dashboard.arbitragesDecides }}</h3>
      <p>D√©cid√©s</p>
    </div>
    <div class="stat-card warning">
      <h3>{{ dashboard.arbitragesUrgents }}</h3>
      <p>Urgents</p>
    </div>
  </div>

  <!-- Alertes -->
  <div class="alertes-section" *ngIf="dashboard && dashboard.alertes.length > 0">
    <div class="alerte" *ngFor="let alerte of dashboard.alertes">
      ‚ö†Ô∏è {{ alerte }}
    </div>
  </div>

  <!-- Loading -->
  <div class="loading" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Chargement des arbitrages...</p>
  </div>

  <!-- Error -->
  <div class="error" *ngIf="error && !isLoading">
    <p>‚ùå {{ error }}</p>
    <button (click)="refresh()">R√©essayer</button>
  </div>

  <!-- Liste des arbitrages en attente -->
  <div class="arbitrages-section" *ngIf="!isLoading && !error">
    <h2>Arbitrages en Attente de D√©cision</h2>
    
    <div class="arbitrages-grid" *ngIf="arbitragesEnAttente.length > 0">
      <div class="arbitrage-card" 
           *ngFor="let arbitrage of arbitragesEnAttente"
           [class]="getUrgenceClass(arbitrage.urgence)"
           (click)="consulterArbitrage(arbitrage)">
        
        <div class="card-header">
          <span class="arbitrage-id">Arbitrage #{{ arbitrage.id }}</span>
          <span class="urgence-badge" [class]="getUrgenceClass(arbitrage.urgence)">
            {{ arbitrage.urgence }}
          </span>
        </div>

        <div class="card-content">
          <div class="transaction-info">
            <strong>{{ arbitrage.transactionReference }}</strong>
            <p>{{ formatMontant(arbitrage.montantConteste) }}</p>
          </div>

          <div class="banques-info">
            <div class="banque emettrice">
              <label>√âmettrice:</label>
              <span>{{ arbitrage.banqueEmettrice }}</span>
            </div>
            <div class="banque acquereuse">
              <label>Acqu√©reuse:</label>
              <span>{{ arbitrage.banqueAcquereuse }}</span>
            </div>
          </div>

          <div class="motif">
            <label>Motif:</label>
            <p>{{ arbitrage.motifChargeback }}</p>
          </div>

          <div class="delai">
            <label>En attente depuis:</label>
            <span class="jours-attente">{{ arbitrage.joursAttente }} jour(s)</span>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn-primary">
            ‚öñÔ∏è Examiner le dossier
          </button>
        </div>
      </div>
    </div>

    <div class="empty-state" *ngIf="arbitragesEnAttente.length === 0">
      <h3>‚úÖ Aucun arbitrage en attente</h3>
      <p>Tous les arbitrages ont √©t√© trait√©s.</p>
    </div>
  </div>
</div>

<!-- Modal de consultation d√©taill√©e -->
<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-content-large" (click)="$event.stopPropagation()">
    
    <!-- Header du modal -->
    <div class="modal-header">
      <h2>Dossier d'Arbitrage #{{ selectedArbitrage?.id }}</h2>
      <button class="close-btn" (click)="closeDetailsModal()">‚úï</button>
    </div>

    <!-- Navigation par onglets -->
    <div class="tab-navigation">
      <button class="tab-btn" 
              [class.active]="activeTab === 'resume'"
              (click)="setActiveTab('resume')">
        üìã R√©sum√©
      </button>
      <button class="tab-btn" 
              [class.active]="activeTab === 'historique'"
              (click)="setActiveTab('historique')">
        üìÖ Historique
      </button>
      <button class="tab-btn" 
              [class.active]="activeTab === 'justificatifs'"
              (click)="setActiveTab('justificatifs')">
        üìé Justificatifs
      </button>
      <button class="tab-btn" 
              [class.active]="activeTab === 'decision'"
              (click)="setActiveTab('decision')">
        ‚öñÔ∏è D√©cision
      </button>
    </div>

    <!-- Loading du dossier -->
    <div class="loading-details" *ngIf="isLoadingDetails">
      <div class="spinner"></div>
      <p>Chargement du dossier complet...</p>
    </div>

    <!-- Contenu des onglets -->
    <div class="tab-content" *ngIf="!isLoadingDetails && dossierComplet">
      
      <!-- Onglet R√©sum√© -->
      <div class="tab-panel" *ngIf="activeTab === 'resume'">
        <div class="resume-grid">
          
          <!-- Informations g√©n√©rales -->
          <div class="info-section">
            <h3>Informations G√©n√©rales</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>ID Arbitrage:</label>
                <span>#{{ dossierComplet.arbitrage.id }}</span>
              </div>
              <div class="info-item">
                <label>Date de demande:</label>
                <span>{{ formatDate(dossierComplet.arbitrage.dateDemande) }}</span>
              </div>
              <div class="info-item">
                <label>Jours d'attente:</label>
                <span class="highlight-warning">{{ dossierComplet.arbitrage.joursAttente }} jour(s)</span>
              </div>
              <div class="info-item">
                <label>Urgence:</label>
                <span class="urgence-badge" [class]="getUrgenceClass(dossierComplet.arbitrage.urgence)">
                  {{ dossierComplet.arbitrage.urgence }}
                </span>
              </div>
              <div class="info-item">
                <label>Institution demandeuse:</label>
                <span>{{ dossierComplet.arbitrage.institutionDemandeuse }}</span>
              </div>
              <div class="info-item">
                <label>Co√ªt d'arbitrage:</label>
                <span class="highlight-amount">{{ formatMontant(dossierComplet.arbitrage.coutArbitrage) }}</span>
              </div>
            </div>
          </div>

          <!-- Transaction concern√©e -->
          <div class="info-section">
            <h3>Transaction Concern√©e</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>R√©f√©rence:</label>
                <span class="highlight-ref">{{ dossierComplet.transaction.reference }}</span>
              </div>
              <div class="info-item">
                <label>Montant transaction:</label>
                <span>{{ formatMontant(dossierComplet.transaction.montant) }}</span>
              </div>
              <div class="info-item">
                <label>Montant contest√©:</label>
                <span class="highlight-amount">{{ formatMontant(dossierComplet.arbitrage.montantConteste) }}</span>
              </div>
              <div class="info-item">
                <label>Date transaction:</label>
                <span>{{ formatDate(dossierComplet.transaction.dateTransaction) }}</span>
              </div>
              <div class="info-item">
                <label>Type:</label>
                <span>{{ dossierComplet.transaction.type }}</span>
              </div>
            </div>
          </div>

          <!-- Banques impliqu√©es -->
          <div class="info-section">
            <h3>Banques Impliqu√©es</h3>
            <div class="banques-details">
              <div class="banque-card emettrice">
                <h4>üè¶ Banque √âmettrice</h4>
                <p><strong>{{ dossierComplet.banqueEmettrice.nom || 'Banque √©mettrice inconnue' }}</strong></p>
                <p>ID: {{ dossierComplet.banqueEmettrice.id || 'N/A' }}</p>
              </div>
              <div class="vs-separator">VS</div>
              <div class="banque-card acquereuse">
                <h4>üè™ Banque Acqu√©reuse</h4>
                <p><strong>{{ dossierComplet.banqueAcquereuse.nom || 'Banque acqu√©reuse inconnue' }}</strong></p>
                <p>ID: {{ dossierComplet.banqueAcquereuse.id || 'N/A' }}</p>
              </div>
            </div>
          </div>

          <!-- R√©sum√© du chargeback -->
          <div class="info-section full-width">
            <h3>R√©sum√© du Chargeback</h3>
            <div class="chargeback-timeline">
              <div class="timeline-item">
                <div class="timeline-marker initiation"></div>
                <div class="timeline-content">
                  <h4>Initiation du Chargeback</h4>
                  <p><strong>Date:</strong> {{ formatDate(dossierComplet.chargeback.dateInitiation) }}</p>
                  <p><strong>Motif:</strong> {{ dossierComplet.chargeback.motifInitial }}</p>
                </div>
              </div>
              
              <div class="timeline-item" *ngIf="dossierComplet.chargeback.dateRepresentation">
                <div class="timeline-marker representation"></div>
                <div class="timeline-content">
                  <h4>Repr√©sentation</h4>
                  <p><strong>Date:</strong> {{ formatDate(dossierComplet.chargeback.dateRepresentation) }}</p>
                  <p>Arguments de d√©fense pr√©sent√©s</p>
                </div>
              </div>
              
              <div class="timeline-item" *ngIf="dossierComplet.chargeback.dateSecondPresentment">
                <div class="timeline-marker second-presentment"></div>
                <div class="timeline-content">
                  <h4>Second Presentment</h4>
                  <p><strong>Date:</strong> {{ formatDate(dossierComplet.chargeback.dateSecondPresentment) }}</p>
                  <p>R√©futation et nouveaux arguments</p>
                </div>
              </div>
              
              <div class="timeline-item current">
                <div class="timeline-marker arbitrage"></div>
                <div class="timeline-content">
                  <h4>Arbitrage</h4>
                  <p><strong>Phase actuelle:</strong> {{ dossierComplet.chargeback.phaseActuelle }}</p>
                  <p>En attente de d√©cision administrative</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Onglet Historique -->
      <div class="tab-panel" *ngIf="activeTab === 'historique'">
        <div class="historique-container">
          <h3>Historique Complet des √âchanges</h3>
          
          <div class="historique-list">
            <div class="historique-item" 
                 *ngFor="let echange of dossierComplet.historique; trackBy: trackByHistorique">
              <div class="historique-marker" 
                   [style.backgroundColor]="getPhaseColor(echange.phase)"></div>
              <div class="historique-content">
                <div class="historique-header">
                  <span class="historique-date">{{ formatDateTime(echange.date) }}</span>
                  <span class="historique-phase">{{ echange.phase }}</span>
                </div>
                <h4>{{ echange.action }}</h4>
                <p>{{ echange.details }}</p>
                <div class="historique-footer">
                  <span class="historique-auteur">Par: {{ echange.auteur }}</span>
                  <span class="historique-institution">{{ echange.institution }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Onglet Justificatifs -->
      <div class="tab-panel" *ngIf="activeTab === 'justificatifs'">
        <div class="justificatifs-container">
          <h3>Documents et Justificatifs</h3>
          
          <div class="justificatifs-grid">
            <div class="justificatif-card" 
                 *ngFor="let justificatif of dossierComplet.justificatifs; trackBy: trackByJustificatif">
              <div class="justificatif-icon">
                üìÑ
              </div>
              <div class="justificatif-info">
                <h4>{{ justificatif.nom }}</h4>
                <p><strong>Type:</strong> {{ justificatif.type }}</p>
                <p><strong>Phase:</strong> {{ justificatif.phase }}</p>
                <p><strong>Taille:</strong> {{ formatFileSize(justificatif.taille) }}</p>
                <p><strong>Ajout√© le:</strong> {{ formatDate(justificatif.dateAjout) }}</p>
                <p><strong>Institution:</strong> {{ justificatif.institution }}</p>
              </div>
              <div class="justificatif-actions">
                <button class="btn-download" (click)="downloadJustificatif(justificatif)">
                  üì• T√©l√©charger
                </button>
              </div>
            </div>
          </div>
          
          <div class="empty-justificatifs" *ngIf="dossierComplet.justificatifs.length === 0">
            <p>Aucun justificatif disponible</p>
          </div>
        </div>
      </div>

      <!-- Onglet D√©cision -->
      <div class="tab-panel" *ngIf="activeTab === 'decision'">
        <div class="decision-container">
          <h3>Rendu de D√©cision d'Arbitrage</h3>
          
          <form class="decision-form">
            <!-- D√©cision principale -->
            <div class="form-group">
              <label for="decision">D√©cision *</label>
              <select id="decision" 
                      [(ngModel)]="decisionForm.decision" 
                      name="decision"
                      (change)="onDecisionChange()"
                      class="form-control">
                <option value="FAVORABLE_EMETTEUR">Favorable √† la banque √©mettrice</option>
                <option value="FAVORABLE_ACQUIREUR">Favorable √† la banque acqu√©reuse</option>
                <option value="PARTAGE">Partage de responsabilit√©</option>
                <option value="REJET">Rejet de la demande d'arbitrage</option>
              </select>
            </div>

            <!-- Montant accord√© -->
            <div class="form-group" *ngIf="decisionForm.decision !== 'REJET'">
              <label for="montantAccorde">Montant accord√© *</label>
              <div class="input-with-currency">
                <input type="number" 
                       id="montantAccorde"
                       [(ngModel)]="decisionForm.montantAccorde"
                       name="montantAccorde"
                       [max]="selectedArbitrage?.montantConteste || 0"
                       min="0"
                       step="0.01"
                       class="form-control">
                <span class="currency">MAD</span>
              </div>
              <small class="form-text">
                Maximum: {{ formatMontant(selectedArbitrage?.montantConteste || 0) }}
              </small>
            </div>

            <!-- R√©partition des frais -->
            <div class="form-group">
              <label for="repartitionFrais">R√©partition des frais d'arbitrage *</label>
              <select id="repartitionFrais" 
                      [(ngModel)]="decisionForm.repartitionFrais" 
                      name="repartitionFrais"
                      class="form-control">
                <option value="DEMANDEUR">√Ä la charge du demandeur</option>
                <option value="DEFENDEUR">√Ä la charge du d√©fendeur</option>
                <option value="PARTAGE">Partag√©s √©quitablement</option>
                <option value="PERDANT">√Ä la charge de la partie perdante</option>
              </select>
            </div>

            <!-- Motifs de la d√©cision -->
            <div class="form-group">
              <label for="motifsDecision">Motifs de la d√©cision *</label>
              <textarea id="motifsDecision"
                        [(ngModel)]="decisionForm.motifsDecision"
                        name="motifsDecision"
                        rows="6"
                        class="form-control"
                        placeholder="Exposez les motifs d√©taill√©s de votre d√©cision (minimum 50 caract√®res)..."></textarea>
              <div class="char-counter" 
                   [class.valid]="decisionForm.motifsDecision && decisionForm.motifsDecision.length >= 50">
                {{ (decisionForm.motifsDecision?.length || 0) }} / 50 caract√®res minimum
              </div>
            </div>

            <!-- D√©lai d'ex√©cution -->
            <div class="form-group">
              <label for="delaiExecution">D√©lai d'ex√©cution (jours)</label>
              <input type="number" 
                     id="delaiExecution"
                     [(ngModel)]="decisionForm.delaiExecution"
                     name="delaiExecution"
                     min="1"
                     max="90"
                     class="form-control">
              <small class="form-text">
                D√©lai accord√© aux parties pour l'ex√©cution de la d√©cision
              </small>
            </div>

            <!-- Commentaires suppl√©mentaires -->
            <div class="form-group">
              <label for="commentairesSupplementaires">Commentaires suppl√©mentaires</label>
              <textarea id="commentairesSupplementaires"
                        [(ngModel)]="decisionForm.commentairesSupplementaires"
                        name="commentairesSupplementaires"
                        rows="3"
                        class="form-control"
                        placeholder="Commentaires ou instructions additionnelles (optionnel)..."></textarea>
            </div>

            <!-- R√©sum√© de la d√©cision -->
            <div class="decision-summary" *ngIf="isDecisionFormValid()">
              <h4>R√©sum√© de la D√©cision</h4>
              <div class="summary-content">
                <p><strong>D√©cision:</strong> {{ getDecisionLabel(decisionForm.decision) }}</p>
                <p *ngIf="decisionForm.decision !== 'REJET'">
                  <strong>Montant accord√©:</strong> {{ formatMontant(decisionForm.montantAccorde || 0) }}
                </p>
                <p><strong>Frais d'arbitrage:</strong> {{ getRepartitionLabel(decisionForm.repartitionFrais) }}</p>
                <p *ngIf="decisionForm.delaiExecution">
                  <strong>D√©lai d'ex√©cution:</strong> {{ decisionForm.delaiExecution }} jour(s)
                </p>
              </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
              <button type="button" 
                      class="btn-secondary" 
                      (click)="setActiveTab('resume')">
                Retour au r√©sum√©
              </button>
              <button type="button" 
                      class="btn-primary" 
                      [disabled]="!isDecisionFormValid()"
                      (click)="openConfirmDecisionModal()">
                Rendre la d√©cision
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation de d√©cision -->
<div class="modal-overlay" *ngIf="showConfirmDecisionModal" (click)="closeConfirmDecisionModal()">
  <div class="modal-content-confirm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Confirmation de la D√©cision d'Arbitrage</h3>
      <button class="close-btn" (click)="closeConfirmDecisionModal()">‚úï</button>
    </div>
    
    <div class="modal-body">
      <div class="warning-message">
        <p>‚ö†Ô∏è <strong>Attention :</strong> Cette action est d√©finitive et ne pourra pas √™tre annul√©e.</p>
      </div>
      
      <div class="decision-confirmation">
        <h4>R√©sum√© de votre d√©cision :</h4>
        <div class="confirmation-details">
          <p><strong>Arbitrage :</strong> #{{ selectedArbitrage?.id }}</p>
          <p><strong>Transaction :</strong> {{ selectedArbitrage?.transactionReference }}</p>
          <p><strong>Montant en jeu :</strong> {{ formatMontant(selectedArbitrage?.montantConteste || 0) }}</p>
          <hr>
          <p><strong>Votre d√©cision :</strong> {{ getDecisionLabel(decisionForm.decision) }}</p>
          <p *ngIf="decisionForm.decision !== 'REJET'">
            <strong>Montant accord√© :</strong> {{ formatMontant(decisionForm.montantAccorde || 0) }}
          </p>
          <p><strong>R√©partition des frais :</strong> {{ getRepartitionLabel(decisionForm.repartitionFrais) }}</p>
          <p><strong>D√©lai d'ex√©cution :</strong> {{ decisionForm.delaiExecution }} jour(s)</p>
        </div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn-secondary" (click)="closeConfirmDecisionModal()">
        Annuler
      </button>
      <button class="btn-danger" 
              [disabled]="isProcessingDecision"
              (click)="confirmerDecision()">
        <span *ngIf="!isProcessingDecision">‚úÖ Confirmer la d√©cision</span>
        <span *ngIf="isProcessingDecision">‚è≥ Traitement en cours...</span>
      </button>
    </div>
  </div>
</div>